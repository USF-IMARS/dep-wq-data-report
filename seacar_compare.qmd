---
title: "Dep-wq-data-report"
description: DEP Water Quality Data Report
code-fold: true
---

# dep-seacar-imars-qc-compare
Comparison of IMaRS QC and SEACAR QC outputs for DEP project
  
## Data Loading & Alignment
  
```{r}
#| label: import libraries & functions
#| code-summary: (code) import libraries & functions
#| message: false
#| warning: false

if (!requireNamespace("librarian", quietly = TRUE)) {
  install.packages("librarian")
}
librarian::shelf(
  ggplot2,
  glue,
  here,
  readxl,
  tidyverse,
  utils
)
```

```{R}
# unzip SEACAR files
library(utils)
library(glue)

input_dir <- here("./data/01-SEACAR_raw")
output_dir <- here("./data/02-SEACAR_unzipped")

# Create the output directory if it doesn't exist
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# List all .zip files in the input directory
zip_files <- list.files(
  input_dir, pattern = "\\.zip$", full.names = TRUE
)

# Loop through each zip file
for (zip_file in zip_files) {
  # Get the base name of the zip file 
  # (without directory and .zip extension)
  zip_name <- tools::file_path_sans_ext(basename(zip_file))
  
  cat(glue("unzipping to {output_dir}/{zip_name}/..."))
  
  # Create a subfolder in the output directory 
  # with the name of the zip file
  unzip_dir <- file.path(output_dir, zip_name)
  if (!dir.exists(unzip_dir)) {
    dir.create(unzip_dir)
  }
  
  # Unzip the file into the created subfolder
  unzip(zip_file, exdir = unzip_dir)
  cat("done.\n")
}
```

```{R}
# Load SEACAR file
seacar_data <- read_delim(
  here("./data/02-SEACAR_unzipped/AOML/Discrete\ WQ\ -\ 3.txt"),
  delim="|"
)

# Load IMaRS-processed data & align to SEACAR columns
imars_data <- read_csv(
  "./data/df_cleaned.csv"
) %>%
  filter(Source == "AOML") %>%
  mutate(
    ParameterName = Parameter,
    OriginalLatitude = Latitude,
    OriginalLongitude = Longitude,
    ProgramLocationID = Site,
    ResultValue = verbatimValue,
    SampleDate = glue(
      "{Year}-{sprintf('%02d', Month)}-{sprintf('%02d', Day)}"
    )  
  )
```

## Inspect an Example Provider (AOML)

### `ParameterName` values malignment
`ParameterName` columns have different values for same data.
Some columns appear to not exist in both.

```{R}
#| code-summary: print unique values for param name
print("=== IMaRS ==========================")
print(unique(imars_data$ParameterName))
print("=== SEACAR ==========================")
print(unique(seacar_data$ParameterName))

```

A mapping of names manually creating using AOML data is below:

IMaRS Name          | SEACAR name 
--------------------|-------------------------
Ammonium (N)        | Ammonium, Filtered (NH4)
Chlorophyll a	      | Chlorophyll a, Uncorrected for Pheophytin
-                   | Colored Dissolved Organic Matter
-                   | Light Extinction Coefficient
Nitrate (N)         | - 
Nitrate-Nitrite (N) | NO2+3, Filtered
Nitrite (N)         | - 
Orthophosphate (P)  |
-                   | pH
-                   | Phosphate, Filtered (PO4)
-                   | Salinity
Silica              | 
-                   | Total Suspended Solids
-                   | Water Temperature


```{R}
# Count the number of points for each reporting provider in SEACAR and DEP data
seacar_count <- seacar_data %>%
  group_by(ParameterName) %>%
  summarise(count = n())

imars_count <- imars_data %>%
  group_by(ParameterName) %>%
  summarise(count = n())

# Combine and display the results
comparison_count <- full_join(seacar_count, imars_count, by = "ParameterName", suffix = c("_SEACAR", "_IMaRS"))
comparison_count
```


### Ammonia distribution across all sites

```{R}
# Select relevant nutrient columns from SEACAR and DEP datasets
# Plot distributions side by side for SEACAR and IMaRS (DEP)

# Combine the datasets with a new column to identify the source
combined_data <- bind_rows(
  seacar_data %>% 
    select(ParameterName, ResultValue) %>%
    filter(ParameterName == "Ammonium, Filtered (NH4)") %>% 
    mutate(Source = "SEACAR"),
  imars_data %>% 
    select(ParameterName, ResultValue) %>%
    filter(ParameterName == "Ammonium (N)") %>% 
    mutate(Source = "IMaRS")
)

# Plot side-by-side distributions with log-scaled x-axis
ggplot(combined_data, aes(x = ResultValue, fill = Source)) +
  geom_density(alpha = 0.5) +
  labs(title = "Ammonium Distributions: SEACAR vs IMaRS (Log Scale)",
       x = "Nutrient Value (Log Scale)",
       y = "Density",
       fill = "Source") +
  scale_x_log10() +   # Log scale on the x-axis
  theme_minimal()


```


### Site ID malignment
Site IDs in each are radically different:

```{R}
imars_sites <- sort(unique(imars_data$ProgramLocationID))
seacar_sites <- sort(unique(seacar_data$ProgramLocationID))

print("=== IMaRS ==========================")
print(imars_sites[1:5])
print("=== SEACAR ==========================")
print(seacar_sites[1:5])

```

SEACAR data has many more site names

```{R}
print("=== IMaRS ==========================")
print(length(imars_sites))
print("=== SEACAR ==========================")
print(length(seacar_sites))

```


### TODO: compare specific stations
Cannot compare within stations until station number mapping is completed (see above section about station id malignment).

